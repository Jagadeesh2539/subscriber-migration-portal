<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸš€ Enhanced Migration Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #4f46e5;
      --color-primary-hover: #4338ca;
      --color-secondary: #6b7280;
      --color-danger: #ef4444;
      --color-success: #22c55e;
      --color-warning: #f59e0b;
      --color-info: #3b82f6;
      --bg-body: #f3f4f6;
      --bg-sidebar: #1f2937;
      --bg-card: #ffffff;
      --bg-light: #f9fafb;
      --text-dark: #111827;
      --text-light: #6b7280;
      --text-white: #ffffff;
      --border-color: #e5e7eb;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
      --radius: 8px;
      --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font-main);
      background-color: var(--bg-body);
      color: var(--text-dark);
      -webkit-font-smoothing: antialiased;
    }
    #login-screen {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      overflow: hidden;
    }
    /* This ::before pseudo-element creates the grid background */
    #login-screen::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3Cpattern id='grid' width='10' height='10' patternUnits='userSpaceOnUse'%3E%3Cpath d='M 10 0 L 0 0 0 10' fill='none' stroke='rgba(255,255,255,0.1)' stroke-width='0.5'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grid)'/%3E%3C/svg%3E") repeat;
    }
    .login-card {
      position: relative;
      z-index: 1;
      width: 100%; max-width: 420px; padding: 48px 40px;
      background: var(--bg-card); border-radius: 16px;
      box-shadow: var(--shadow-lg); text-align: center;
    }
    .login-header { margin-bottom: 32px; }
    .login-header .logo { 
      font-size: 48px; margin-bottom: 16px;
      background: linear-gradient(135deg, var(--color-primary), #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .login-header h2 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    #app-shell { display: none; }
    .sidebar {
      position: fixed; left: 0; top: 0; width: 260px; height: 100vh;
      background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
      box-shadow: 2px 0 12px rgba(0,0,0,0.15); z-index: 1000;
      display: flex; flex-direction: column;
    }
    .sidebar-header { 
      padding: 24px; text-align: center; 
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: rgba(79, 70, 229, 0.1);
    }
    .sidebar-header h2 { color: #ffffff; margin-bottom: 4px; }
    .sidebar-header div { color: rgba(255,255,255,0.6); }
    .nav-menu { flex-grow: 1; overflow-y: auto; padding: 16px 0; }
    .nav-item {
      display: flex; align-items: center; gap: 12px; padding: 14px 24px;
      cursor: pointer; font-size: 15px; color: rgba(255,255,255,0.7);
      transition: all 0.3s ease; border-radius: 8px; margin: 4px 12px;
    }
    .nav-item:hover { 
      background-color: rgba(79, 70, 229, 0.2); 
      color: #ffffff;
      transform: translateX(4px);
    }
    .nav-item.active {
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.3), rgba(79, 70, 229, 0.1));
      color: #ffffff; font-weight: 600;
      border-left: 4px solid var(--color-primary);
      box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);
    }
    .nav-item span { font-size: 18px; }
    .sidebar-footer { 
      padding: 16px 24px; 
      border-top: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
    }
    .sidebar-footer span { color: #ffffff; font-weight: 600; }
    .sidebar-footer a { color: rgba(255,255,255,0.6); }
    .sidebar-footer a:hover { color: var(--color-primary); }
    .main-content { margin-left: 260px; padding: 32px; min-height: 100vh; }
    .page-header { margin-bottom: 32px; }
    .page-header h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
    .card {
      background: var(--bg-card); padding: 24px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px; 
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    .card:hover { 
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    .card h2 { 
      font-size: 20px; font-weight: 600; margin-bottom: 16px;
      color: var(--text-dark); display: flex; align-items: center; gap: 8px;
    }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
      color: var(--text-white); border: none;
      padding: 10px 16px; border-radius: 8px; cursor: pointer;
      font-size: 13px; font-weight: 600; transition: all 0.3s ease;
    }
    .btn:hover { 
      background: linear-gradient(135deg, var(--color-primary-hover), #3730a3);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
    }
    .btn:active { transform: translateY(0px); }
    .btn-secondary { background: var(--color-secondary); }
    .btn-sm { padding: 8px 14px; font-size: 13px; }
    .form-input {
      width: 100%; padding: 12px 16px; border-radius: var(--radius);
      border: 1px solid var(--border-color); font-size: 14px;
    }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; }
    .status-badge {
      padding: 6px 12px; border-radius: 20px; font-weight: 600;
      font-size: 12px; display: inline-block;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    .status-badge:hover { transform: scale(1.05); }
    .status-badge.success { 
      background: linear-gradient(135deg, #dcfce7, #bbf7d0); 
      color: #166534; border: 1px solid #86efac;
    }
    .status-badge.error { 
      background: linear-gradient(135deg, #fee2e2, #fecaca); 
      color: #991b1b; border: 1px solid #fca5a5;
    }
    .status-badge.info { 
      background: linear-gradient(135deg, #dbeafe, #bfdbfe); 
      color: #1e40af; border: 1px solid #93c5fd;
    }
     .status-badge.warning { 
      background: linear-gradient(135deg, #fef3c7, #fde68a); 
      color: #92400e; border: 1px solid #fcd34d;
    }
    .alert { padding: 16px; border-radius: var(--radius); margin: 16px 0; }
    .alert.success { background: #f0fdf4; color: #166534; }
    .alert.error { background: #fef2f2; color: #991b1b; }
    .alert.info { background: #eff6ff; color: #1e40af; }
    .results-table {
      width: 100%; border-collapse: collapse; margin: 20px 0;
      background: var(--bg-card); border-radius: 12px;
      overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .results-table th, .results-table td {
      padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color);
    }
    .results-table th { 
      background: linear-gradient(180deg, #f9fafb, #f3f4f6); 
      font-weight: 600; color: var(--text-dark);
      border-bottom: 2px solid var(--color-primary);
    }
    .results-table tbody tr { transition: all 0.2s ease; }
    .results-table tbody tr:hover { 
      background: #f9fafb; 
      transform: scale(1.01);
    }
    .progress-bar {
      width: 100%; height: 8px; background: var(--bg-light);
      border-radius: 4px; overflow: hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    .progress-fill {
      height: 100%; 
      background: linear-gradient(90deg, var(--color-primary), var(--color-info));
      transition: width 0.3s ease;
      box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
    }
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 24px; margin: 32px 0;
    }
    .stat-card {
      background: var(--bg-card); padding: 24px; border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center;
      transition: all 0.3s ease; border: 1px solid var(--border-color);
      position: relative; overflow: hidden;
    }
    .stat-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0;
      height: 4px; background: linear-gradient(90deg, var(--color-primary), var(--color-info));
    }
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    .stat-card > div:first-child { font-size: 2em; margin-bottom: 8px; }
    .stat-card h3 { color: var(--text-light); font-size: 14px; margin-bottom: 8px; }
    .stat-number { 
      font-size: 2.2em; font-weight: 700; margin: 8px 0;
      background: linear-gradient(135deg, var(--color-primary), var(--color-info));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .page-section { display: none; }
    .page-section.active { display: block; }
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      z-index: 2000; align-items: center; justify-content: center;
    }
    .modal {
      background: var(--bg-card); padding: 32px; border-radius: 16px;
      max-width: 600px; width: 90%; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; }
    
    .state-container { text-align: center; padding: 60px 20px; border: 2px dashed var(--border-color); border-radius: var(--radius); background: var(--bg-light); }
    .state-container .icon { font-size: 48px; margin-bottom: 16px; }
    .state-container h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .state-container p { color: var(--text-light); margin-bottom: 24px; }
	
	/* ADD THIS TO <style> SECTION */
.health-indicator {
  padding: 12px;
  border: 2px solid #d1d5db;
  border-radius: 8px;
  text-align: center;
  transition: all 0.3s ease;
}

.health-indicator:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.health-indicator.healthy {
  border-color: var(--color-success);
}

.health-indicator.unhealthy {
  border-color: var(--color-danger);
}

.health-icon {
  font-size: 24px;
  margin-bottom: 8px;
}

.health-label {
  font-weight: 600;
  margin-bottom: 4px;
  font-size: 13px;
}

.health-status-text {
  font-size: 12px;
  font-weight: 600;
}


/* ADD THESE BUTTON VARIANTS */
.btn-danger {
  background: linear-gradient(135deg, var(--color-danger), #dc2626);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.btn-success {
  background: linear-gradient(135deg, var(--color-success), #16a34a);
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.btn-danger:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
}

.btn-success:hover {
  background: linear-gradient(135deg, #16a34a, #15803d);
}

/* Jobs Table Responsive */
.table {
  min-width: 800px; /* Force minimum width */
  font-size: 13px;
}

.table th, .table td {
  padding: 8px 12px;
  font-size: 12px;
}

.table th {
  white-space: nowrap;
  background: var(--bg-light);
}

/* Compact action buttons */
.table .btn-sm {
  padding: 4px 8px;
  font-size: 12px;
}

	
  </style>
</head>
<body>

  <div id="login-screen" style="display: none;">
    <div class="login-card">
      <div class="login-header">
        <div class="logo">ğŸ¢</div>
        <h2>Migration Portal</h2>
        <p>Secure Access</p>
      </div>
      <div class="form-group">
        <label for="username">Username</label>
        <input type="text" id="username" class="form-input" value="admin">
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" class="form-input" value="password">
      </div>
      <button id="login-btn" class="btn" style="width: 100%;">Sign In</button>
    </div>
  </div>

  <div id="app-shell" style="display: none;">
    <nav class="sidebar">
      <div class="sidebar-header">
        <h2>Migration Portal</h2>
        <div style="font-size: 12px; color: var(--text-light);">v2.4.0</div>
      </div>
      <div class="nav-menu">
        <div class="nav-item active" data-page="dashboard"><span>ğŸ“Š</span> Dashboard</div>
        <div class="nav-item" data-page="migration"><span>ğŸ”„</span> Migration</div>
        <div class="nav-item" data-page="provisioning"><span>ğŸ‘¥</span> Provisioning</div>
        <div class="nav-item" data-page="query"><span>ğŸ”</span> Global Data Query</div>
		<div class="nav-item" data-page="bulk-delete"><span>ğŸ—‘ï¸</span> Bulk Delete</div>
        <div class="nav-item" data-page="sql-export"><span>ğŸ“Š</span> Local Data Export</div>
        <div class="nav-item" data-page="monitoring"><span>ğŸ“ˆ</span> Monitoring</div>
        <div class="nav-item" data-page="settings"><span>âš™ï¸</span> Settings</div>
      </div>
      <div class="sidebar-footer">
        <div style="text-align: center;">
          <span id="username-display">Admin</span><br>
          <a id="logout-btn" style="font-size: 12px; cursor: pointer;">Sign Out</a>
        </div>
      </div>
    </nav>

    <main class="main-content">

      <section id="dashboard" class="page-section active">
        <div class="page-header">
          <h1>ğŸ“Š Dashboard</h1>
          <p>System overview and health status</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div>ğŸ‘¥</div>
            <h3>Total Subscribers</h3>
            <div class="stat-number" id="total-subscribers">-</div>
          </div>
          <div class="stat-card">
            <div>âœ…</div>
            <h3>Success Rate</h3>
            <div class="stat-number" id="success-rate">-</div>
          </div>
        </div>

        <div class="card">
          <h2>API Status</h2>
          <div id="api-status" class="alert info">Testing connection...</div>
          <button class="btn" onclick="testAPI(); loadHealthStatus();">Test Connection</button>
        </div>
		
		  <!-- HEALTH MONITORING - ADD THIS -->
        <div class="card">
          <h2>ğŸ¥ System Health</h2>
          <div id="health-status" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
        <div style="padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; margin-bottom: 8px;">â³</div>
        <div style="font-weight: 600; margin-bottom: 4px;">Loading...</div>
        <div style="font-size: 13px; color: #6b7280;">Checking health</div>
        </div>
     </div>
  </div>
</section>

		
      </section>

      <section id="migration" class="page-section">
        <div class="page-header">
          <h1>ğŸ”„ Migration Management</h1>
          <p>Upload files, manage bulk operations, and monitor migration progress.</p>
        </div>

        <div class="card" style="border-left: 4px solid var(--color-primary); margin-bottom: 24px;">
          <h2>ğŸ“¤ Subscriber Migration from Legacy to Cloud</h2>
          <p style="color: var(--text-light); margin-bottom: 20px;">
            Upload CSV with subscriber identifiers.
            <br><strong>Supported:</strong> uid
          </p>
          
          <div class="form-group">
            <label>Upload the Input File</label>
            <input type="file" id="csv-file-input" accept=".csv" class="form-input" />
            <small style="color: var(--text-light); display: block; margin-top: 8px;">
              <strong>Format:</strong><br/uid<br/>32<br/>23
            </small>
          </div>
          
          <button class="btn" onclick="uploadCSV()">ğŸ“¤ Start Migration</button>
          <div id="csv-upload-status" style="margin-top: 16px;"></div>
        </div>

        <div class="card">
		<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
			<h2 style="margin: 0;">ğŸ“Š Migration Jobs</h2>
			<button class="btn btn-secondary btn-sm" onclick="refreshJobs()">ğŸ”„ Refresh</button>
		</div>
		<div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
			<div id="migration-jobs-container"></div>
			</div>
		</div>
	  </section>
      <!-- BULK DELETE SECTION -->
 <!-- BULK DELETE SECTION -->
<section id="bulk-delete" class="page-section">
  <div class="page-header">
    <h1>ğŸ—‘ï¸ Bulk Delete</h1>
    <p>Delete multiple subscribers by uploading a CSV file with UIDs</p>
  </div>

  <!-- UPLOAD FORM -->
  <div class="card" style="border-left: 4px solid var(--color-danger);">
    <h2>âš ï¸ Bulk Delete Subscribers [Cloud only]</h2>
    <p style="color: var(--color-danger); font-weight: 600;">WARNING: This action cannot be undone!</p>
    
    <div class="form-group">
      <label>CSV File (must contain 'uid' column)</label>
      <input type="file" id="bulk-delete-file" class="form-input" accept=".csv">
    </div>
    
    <button class="btn btn-danger" onclick="executeBulkDelete()">
      ğŸ—‘ï¸ Delete Subscribers
    </button>
    
    <div id="bulk-delete-result" style="margin-top: 20px;"></div>
  </div>

  <!-- DELETION JOBS LIST -->
  <div class="card" style="margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">ğŸ“Š Deletion Jobs</h2>
      <button class="btn btn-secondary btn-sm" onclick="refreshDeletionJobs()">ğŸ”„ Refresh</button>
    </div>
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
      <div id="deletion-jobs-list"></div>
    </div>
  </div>
</section>
	  
	        <!-- SQL EXPORT SECTION -->
      <section id="sql-export" class="page-section">
        <div class="page-header">
          <h1>ğŸ“Š Bulk Data Query</h1>
          <p>Execute Data query and export results to CSV</p>
		  <p style="color: var(--color-info); font-weight: 500; margin-top: 8px;">
      **Note:** Queries are executed against the database corresponding to the **Provisioning Mode** currently selected in the âš™ï¸ Settings tab.
          </p>
        </div>

        <div class="card" style="border-left: 4px solid var(--color-info);">
          <h2>ğŸ“ Bulk Query Export</h2>
          
          <div class="form-group">
            <label>SQL Query (SELECT only)</label>
            <textarea id="sql-query-input" class="form-input" rows="6" placeholder="SELECT * FROM subscribers WHERE status = 'ACTIVE' LIMIT 100"></textarea>
          </div>
          
		  <div style="margin-bottom: 16px;">
  <label style="display: block; font-weight: 600; margin-bottom: 8px;">ğŸ“Œ Quick Queries:</label>
  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
    <button class="btn btn-sm btn-secondary" onclick="loadQuickQuery('all')">
      ğŸ“‹ All Subscribers
    </button>
    <button class="btn btn-sm btn-secondary" onclick="loadQuickQuery('uid')">
      ğŸ”‘ UIDs Only
    </button>
    <button class="btn btn-sm btn-secondary" onclick="loadQuickQuery('active')">
      âœ… Active Only
    </button>
    <button class="btn btn-sm btn-secondary" onclick="loadQuickQuery('recent')">
      ğŸ•’ Recent (7 Days)
    </button>
    <button class="btn btn-sm btn-secondary" onclick="loadQuickQuery('contacts')">
      ğŸ“ Contact Info
    </button>
  </div>
</div>
          <button class="btn" onclick="executeSQLExport()">
            ğŸ“¥ Export to CSV
          </button>
          
          <div id="sql-export-result" style="margin-top: 20px;"></div>
        </div>
		
		
		
      </section>


      <section id="provisioning" class="page-section">
        <div class="page-header">
          <h1>ğŸ‘¥ Subscriber Provisioning</h1>
          <p>Create, search, and manage individual subscriber accounts.</p>
        </div>

        <div class="card" style="border-left: 4px solid var(--color-success);">
          <h2>â• Create New Subscriber</h2>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label>UID *</label>
              <input type="text" id="create-uid" class="form-input" placeholder="Enter UID" required>
            </div>
            <div class="form-group">
              <label>IMSI *</label>
              <input type="text" id="create-imsi" class="form-input" placeholder="Enter IMSI" required>
            </div>
            <div class="form-group">
              <label>MSISDN *</label>
              <input type="text" id="create-msisdn" class="form-input" placeholder="Enter MSISDN" required>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="create-email" class="form-input" placeholder="Enter Email">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="create-status" class="form-input">
                <option value="ACTIVE">ACTIVE</option>
                <option value="INACTIVE">INACTIVE</option>
                <option value="SUSPENDED">SUSPENDED</option>
              </select>
            </div>
            <div class="form-group">
              <label>Plan</label>
              <input type="text" id="create-plan" class="form-input" placeholder="Enter Plan">
            </div>
          </div>
          
          <button class="btn" onclick="createSubscriber()">â• Create Subscriber</button>
          <div id="create-subscriber-status" style="margin-top: 16px;"></div>
        </div>

        <div class="card">
          <h2>ğŸ” Search & Management</h2>
          <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
            <input type="text" id="search-input" placeholder="Search by UID, email, IMSI, or MSISDN..." class="form-input" style="flex-grow: 1; max-width: 400px;">
            <button class="btn" onclick="provisioning.search()">ğŸ” Search</button>
            <button class="btn btn-secondary" onclick="provisioning.loadAll()">ğŸ‘¥ Load All</button>
          </div>
          <div id="search-results"></div>
        </div>

        <div class="card" style="border-left: 4px solid var(--color-warning); margin-top: 24px;">
          <h2>âœï¸ Modify Subscriber</h2>
          
          <div class="form-group">
            <label>Search by UID to Modify</label>
            <input type="text" id="modify-search-uid" class="form-input" placeholder="Enter UID to modify">
            <button class="btn btn-secondary btn-sm" onclick="searchForModify()" style="margin-top: 8px;">ğŸ” Search</button>
          </div>

          <div id="modify-form-container" style="display: none; margin-top: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label>UID (Read-only)</label>
                <input type="text" id="modify-uid" class="form-input" readonly>
              </div>
              <div class="form-group">
                <label>IMSI</label>
                <input type="text" id="modify-imsi" class="form-input" placeholder="Enter IMSI">
              </div>
              <div class="form-group">
                <label>MSISDN</label>
                <input type="text" id="modify-msisdn" class="form-input" placeholder="Enter MSISDN">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="modify-email" class="form-input" placeholder="Enter Email">
              </div>
              <div class="form-group">
                <label>Status</label>
                <select id="modify-status" class="form-input">
                  <option value="ACTIVE">ACTIVE</option>
                  <option value="INACTIVE">INACTIVE</option>
                  <option value="SUSPENDED">SUSPENDED</option>
                </select>
              </div>
              <div class="form-group">
                <label>Plan</label>
                <input type="text" id="modify-plan" class="form-input" placeholder="Enter Plan">
              </div>
            </div>
            
            <button class="btn" onclick="modifySubscriber()">âœï¸ Update Subscriber</button>
            <div id="modify-subscriber-status" style="margin-top: 16px;"></div>
          </div>
        </div>
      </section>

      <section id="query" class="page-section">
        <div class="page-header">
          <h1>ğŸ” Global Data Query Interface</h1>
          <p>Search and query subscriber data</p>
        </div>

        <div class="card" style="border-left: 4px solid var(--color-info);">
          <h2>ğŸ” Query Subscribers</h2>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div class="form-group">
              <label>Query Type</label>
              <select id="query-type-select" class="form-input">
                <option value="uid">UID</option>
                <option value="imsi">IMSI</option>
                <option value="msisdn">MSISDN</option>
                <option value="email">Email</option>
              </select>
            </div>
            
            <div class="form-group">
               <label>Data Source</label>
               <select id="query-source-select" class="form-input">
               <option value="cloud">â˜ï¸ Cloud</option>
               <option value="legacy">ğŸ—„ï¸ Legacy</option>
               <option value="both">ğŸ”„ Both (Cloud + Legacy)</option>
               </select>
            </div>
          
            <div class="form-group">
              <label>Query Value</label>
              <input type="text" id="query-value-input" class="form-input" placeholder="Enter identifier value...">
            </div>
            
            <button class="btn btn-sm" onclick="executeQuery()">ğŸ” Execute Query</button>
            
          </div> <div id="query-results-container" style="margin-top: 24px; overflow-x: auto;"></div>

        </div> </section>
      <section id="monitoring" class="page-section">
        <div class="page-header">
          <h1>ğŸ“ˆ System Monitoring</h1>
          <p>Real-time performance metrics and system health monitoring.</p>
        </div>

        <div class="card" style="margin-bottom: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>ğŸ“Š Performance Dashboard</h2>
            <button class="btn btn-secondary btn-sm" onclick="loadPerformance()">ğŸ”„ Refresh</button>
          </div>
          <div id="performance-metrics-container"></div>
        </div>
      </section>

      <section id="settings" class="page-section">
        <div class="page-header">
          <h1>âš™ï¸ System Settings</h1>
          <p>Configure operational parameters and system behavior.</p>
        </div>

        <div class="card">
          <h2>ğŸ›ï¸ Provisioning Configuration</h2>
          <div class="form-group">
            <label for="provisioning-mode">Provisioning Mode</label>
            <select id="provisioning-mode" class="form-input" style="max-width: 300px;">
              <option value="CLOUD">â˜ï¸ Cloud Only Mode</option>
              <option value="LEGACY">ğŸ›ï¸ Legacy Only Mode</option>
              <option value="HYBRID">ğŸ”„ Hybrid Mode</option>
            </select>
          </div>
          <button class="btn btn-success" onclick="settings.saveMode()">ğŸ’¾ Save Configuration</button>
          <div id="settings-status"></div>
        </div>

        <div class="card">
          <h2>ğŸ”§ System Parameters</h2>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group"><label>Migration Batch Size</label><input type="number" id="setting-batch-size" class="form-input" value="1000" min="100" max="10000"></div>
			<div class="form-group"><label>API Timeout (seconds)</label><input type="number" id="setting-api-timeout" class="form-input" value="30" min="10" max="900"></div>
			<div class="form-group"><label>Max Concurrent Jobs</label><input type="number" id="setting-max-jobs" class="form-input" value="3" min="1" max="10"></div>
			<div class="form-group"><label>Log Retention (days)</label><input type="number" id="setting-log-retention" class="form-input" value="30" min="1" max="365"></div>
          </div>
          <button class="btn btn-success" onclick="settings.saveConfig()">ğŸ’¾ Save Settings</button>
        </div>
      </section>

    </main>
  </div>

  <div class="modal-overlay" id="job-modal">
    <div class="modal">
      <h2 id="modal-job-title">Job Details</h2>
      <div id="modal-job-content" style="margin: 20px 0;"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeJobModal()">Close</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="confirmation-modal">
     <div class="modal">
       <h2 id="modal-title">Confirm Action</h2>
       <div id="modal-message" style="margin: 20px 0;">Are you sure?</div>
       <div class="modal-actions">
         <button class="btn btn-secondary" id="modal-cancel">Cancel</button>
         <button class="btn btn-danger" id="modal-confirm">Confirm</button>
       </div>
     </div>
   </div>

  <script>
    // === CONFIG ===
    let authToken = null;
    let currentUser = null;

    // === COMPLETE API CONFIGURATION ===
const APP_CONFIG = {
  DEMO_LOGIN: false,
  API_BASE: 'https://v4ck4txcu3imlqwthb5u2cmenm0hnkgn.lambda-url.us-east-1.on.aws',
  AUTH_API: 'https://v4ck4txcu3imlqwthb5u2cmenm0hnkgn.lambda-url.us-east-1.on.aws/api/auth/login',
  HEALTH_API: 'https://v4ck4txcu3imlqwthb5u2cmenm0hnkgn.lambda-url.us-east-1.on.aws/api/health-ping',
  SUBSCRIBERS_API: 'https://v4ck4txcu3imlqwthb5u2cmenm0hnkgn.lambda-url.us-east-1.on.aws/api/subscribers',
  JOBS_API: 'https://v4ck4txcu3imlqwthb5u2cmenm0hnkgn.lambda-url.us-east-1.on.aws/api/migration/jobs',
  QUERY_API: 'https://v4ck4txcu3imlqwthb5u2cmenm0hnkgn.lambda-url.us-east-1.on.aws/api/query/subscribers',
  SETTINGS_API: 'https://v4ck4txcu3imlqwthb5u2cmenm0hnkgn.lambda-url.us-east-1.on.aws/api/settings',
  MIGRATION_API: 'https://v4ck4txcu3imlqwthb5u2cmenm0hnkgn.lambda-url.us-east-1.on.aws/api/migration',
  VERSION: '3.4.0',
  REFRESH_INTERVAL: 30000
};
    // === UTILITY: API CALL WRAPPER ===
    async function apiCall(endpoint, options = {}) {
      const defaultHeaders = {
        'Content-Type': 'application/json'
      };
      
      if (authToken) {
        defaultHeaders['Authorization'] = `Bearer ${authToken}`;
      }
      
      const config = {
        ...options,
        headers: {
          ...defaultHeaders,
          ...(options.headers || {})
        }
      };
      
      try {
        const url = endpoint.startsWith('http') ? endpoint : (endpoint.startsWith('/') ? `${APP_CONFIG.API_BASE}${endpoint}` : `${APP_CONFIG.API_BASE}/${endpoint}`);
        const response = await fetch(url, config);
        
        // Handle non-JSON responses (like file downloads)
        if (response.headers.get("Content-Type")?.includes("text/csv")) {
          return { response, result: await response.blob() };
        }
        
        const result = await response.json();
        
        // Handle unauthorized
        if (response.status === 401) {
          console.warn('Session expired, logging out...');
          logout();
          throw new Error('Session expired. Please login again.');
        }
        
        return { response, result };
      } catch (error) {
        console.error('API call error:', error);
        throw error;
      }
    }

    // === AUTH ===
function checkAuth() {
      authToken = localStorage.getItem('authToken');
      currentUser = localStorage.getItem('username');

      if (authToken && currentUser) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-shell').style.display = 'block';
        document.getElementById('username-display').textContent = currentUser;
      } else {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('app-shell').style.display = 'none';
      }
    }
    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        showNotification('Please enter username and password', 'error');
        return;
      }
      
      const loginBtn = document.getElementById('login-btn');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';
      
      try {
        // Direct fetch call without apiCall wrapper to avoid recursion
        const response = await fetch(APP_CONFIG.AUTH_API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
        
        const result = await response.json();
        console.log('Login response:', response.status, result);
        
        if (response.ok && result.status === 'success' && result.data && result.data.token) {
          authToken = result.data.token;
          currentUser = result.data.user.username;
          localStorage.setItem('authToken', authToken);
          localStorage.setItem('username', result.data.user.username);
          localStorage.setItem('userRole', result.data.user.role);
          
          console.log('Login successful, token saved:', authToken.substring(0, 20) + '...');
          
          // Show UI immediately
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('app-shell').style.display = 'block';
          document.getElementById('username-display').textContent = currentUser;
          
          showNotification('âœ… Login successful!', 'success');
          
          // Load data after UI is shown
           checkAuth();
		   showPage('dashboard');
        } else {
          console.error('Login failed:', result);
          throw new Error(result.message || result.error || 'Invalid credentials');
        }
      } catch (error) {
        console.error('Login error:', error);
        showNotification('âŒ Login failed: ' + error.message, 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    }

    function logout() {
      localStorage.clear();
      authToken = null;
      currentUser = null;
      checkAuth();
    }

async function testAPI() {
      const statusEl = document.getElementById('api-status');
      statusEl.className = 'alert info';
      statusEl.textContent = 'Testing connection...';
      
      try {
        // 1. CALL THE NEW FAST /api/ping
        const { response, result } = await apiCall('/api/ping'); 
        
        if (response.ok && result.data) {
          // 2. READ THE NEW RESPONSE
          statusEl.className = 'alert success';
          statusEl.textContent = `âœ… Connected! Version: ${result.data.version || 'Unknown'}`;
        } else {
          throw new Error(result.message || 'Health check failed');
        }
      } catch (error) {
        statusEl.className = 'alert error';
        statusEl.textContent = 'âŒ Connection failed: ' + error.message;
      }
    }

    // === DASHBOARD ===
	
// === DASHBOARD ===
	
// NEW: Function to load subscriber count
async function loadSubscriberStats() {
  try {
    const { response, result } = await apiCall('/api/dashboard/stats');
    if (response.ok && result.data) {
      document.getElementById('total-subscribers').textContent = 
        result.data.totalSubscribers || '0';
    } else {
      document.getElementById('total-subscribers').textContent = 'N/A';
    }
  } catch (error) {
     console.error('Dashboard stats load error:', error);
     document.getElementById('total-subscribers').textContent = 'ERR';
  }
}

// NEW: Function to load success rate
async function loadSuccessRate() {
   try {
    const perfResp = await apiCall('/api/dashboard/performance');
    if (perfResp.response.ok && perfResp.result.data) {
      const stats = perfResp.result.data.migration_stats;
      const successRate = stats.total_jobs > 0 
        ? Math.round((stats.completed_jobs / stats.total_jobs) * 100) 
        : 0;
      document.getElementById('success-rate').textContent = successRate + '%';
    } else {
       document.getElementById('success-rate').textContent = 'N/A';
    }
  } catch (e) {
    console.error('Success rate load error:', e);
    document.getElementById('success-rate').textContent = 'ERR';
  }
}

// REPLACED: This function now runs all checks in parallel
async function loadDashboard() {
  // 1. Run the FAST API ping (and await it, it's quick)
   
   testAPI();

  // 2. Run all other dashboard components CONCURRENTLY
  //    (We REMOVED 'await' so they all run in parallel)
  loadHealthStatus();
  loadSubscriberStats();
  loadSuccessRate();
}

// HEALTH STATUS INDICATORS (NEW FAST VERSION)
  async function loadHealthStatus() {
    const container = document.getElementById('health-status');
    try {
      // 1. CALL THE NEW FAST PING
      const { response, result } = await apiCall('/api/health-ping');
      if (!response.ok || !result.data || !result.data.components) {
        throw new Error(result.message || 'Invalid health ping response');
      }

      const components = result.data.components;
      
      // 2. DEFINE LABELS FOR THE *NEW* RESPONSE KEYS
      const labels = {
        dynamodb: 'â˜ï¸ DynamoDB',
        rds: 'ğŸ—„ï¸ RDS MySQL',
        s3: 'ğŸ“¦ S3 Uploads',
        vpc: 'ğŸ” VPC',
        mode: 'âš™ï¸ Provisioning Mode'
      };

      let html = '';
      
      // 3. RENDER THE NEW RESPONSE
      for (const [key, label] of Object.entries(labels)) {
        const comp = components[key];
        if (!comp) continue; // Skip if a component is missing from response

        const status = comp.status || 'unknown'; // 'ok', 'degraded', 'info', 'skipped'
        
        // FIX: Treat 'ok' and 'info' as healthy (green border)
        const isHealthy = (status === 'ok' || status === 'info');
        
        const color = isHealthy ? 'var(--color-success)' : 'var(--color-danger)';
        const icon = isHealthy ? 'âœ…' : 'âŒ';
        let statusText = status.toUpperCase();
        
        // Make status text more readable
        if (status === 'ok') statusText = 'HEALTHY';
        if (status === 'info') statusText = comp.details?.enabled ? 'ENABLED' : 'DISABLED';
        if (status === 'degraded') statusText = 'ERROR';
        if (key === 'mode') statusText = comp.details?.provisioningMode || 'UNKNOWN';


        html += `
          <div style="padding:12px;border:2px solid ${color};border-radius:8px;text-align:center;">
            <div style="font-size:24px;margin-bottom:8px;">${icon}</div>
            <div style="font-weight:600;margin-bottom:4px;font-size:13px;">${label}</div>
            <div style="color:${color};font-size:12px;font-weight:600;">${statusText}</div>
          </div>`;
      }
      container.innerHTML = html;

    } catch (err) {
      console.error('Fast health check failed:', err);
      container.innerHTML =
        `<div style="padding: 12px; border: 2px solid var(--color-danger); border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; margin-bottom: 8px;">âŒ</div>
          <div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">Health Check Failed</div>
          <div style="color:var(--color-danger);font-size:12px;font-weight:600;">${err.message}</div>
         </div>`;
    }
  }



    // === CSV UPLOAD ===
    async function uploadCSV() {
      const fileInput = document.getElementById('csv-file-input');
      const file = fileInput.files[0];
      
      if (!file) {
        showNotification('Please select a CSV file', 'error');
        return;
      }
      
      if (!file.name.endsWith('.csv')) {
        showNotification('Only CSV files are allowed', 'error');
        return;
      }
      
      const statusEl = document.getElementById('csv-upload-status');
      statusEl.innerHTML = '<div class="alert info">ğŸ“¤ Uploading CSV...</div>';
      
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        // Use fetch directly for FormData (don't set Content-Type)
        const response = await fetch(`${APP_CONFIG.MIGRATION_API}/csv-upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` },
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.data) {
            statusEl.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="alert success">
Â  Â  Â  Â  Â  Â  Â  âœ… ${result.message}<br/>
Â  Â  Â  Â  Â  Â  Â  <strong>Job ID:</strong> ${result.data.job_id}<br/>
Â  Â  Â  Â  Â  Â  Â  <strong>Total Subscribers:</strong> ${result.data.total_items}<br/>
Â  Â  Â  Â  Â  Â  Â  <strong>Identifier Type:</strong> uid
Â  Â  Â  Â  Â  Â  </div>
          `;
		  showNotification('Migration started successfully!', 'success');
          fileInput.value = '';
          
          // Refresh jobs after 2 seconds
          setTimeout(() => refreshJobs(), 2000);
        } else {
          throw new Error(result.message || 'Upload failed');
        }
      } catch (error) {
        statusEl.innerHTML = `<div class="alert error">âŒ Upload failed: ${error.message}</div>`;
        showNotification('Upload failed', 'error');
      }
    }

    // === MIGRATION JOBS ===
    async function refreshJobs() {
Â  Â  Â  const container = document.getElementById('migration-jobs-container');

Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const { response, result } = await apiCall(APP_CONFIG.JOBS_API);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (response.ok && result.data && result.data.jobs) { // <-- This 'if' was missing
Â  Â  Â  Â  Â  const migrationJobs = result.data.jobs.filter(job => job.type === 'MIGRATION' || !job.job_type);
Â  Â  Â  Â  Â  displayJobs(migrationJobs);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  throw new Error(result.message || 'Failed to load jobs');
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  container.innerHTML = `<div class="alert error">âŒ ${error.message}</div>`;
Â  Â  Â  }
Â  Â  }

    function displayJobs(jobs) {
      const container = document.getElementById('migration-jobs-container');
      
      if (!jobs || jobs.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light);">No migration jobs found</p>';
        return;
      }
      
      let html = '<table class="results-table table"><thead><tr>';
      html += '<th>Job ID</th><th>Status</th><th>Type</th><th>Summary</th><th>Progress</th><th>Created</th><th>Actions</th>';
      html += '</tr></thead><tbody>';
	 
      
 jobs.forEach(job => {
  const statusClass = (job.status || '').startsWith('COMPLETED') ? 'success' :
                      (job.status === 'FAILED' || (job.status || '').includes('ERROR')) ? 'error' : 'info';

  html += `<tr>
    <td><strong>${job.job_id}</strong></td>
    <td><span class="status-badge ${statusClass}">${job.status}</span></td>
    <td>${job.type || 'N/A'}</td>
    <td>
      <div style="font-size: 13px; white-space: nowrap;">
        <div>${job.total_items || 0} total</div>
        <div style="color: var(--color-success);">âœ“ ${job.successful_items || 0}</div>
        <div style="color: var(--color-danger);">âœ— ${job.failed_items || 0}</div>
      </div>
    </td>
    <td>
      <div class="progress-bar" style="width: 100px;">
        <div class="progress-fill" style="width: ${job.progress || 0}%;"></div>
      </div>
      <small>${job.progress || 0}%</small>
    </td>
    <td style="font-size: 12px; white-space: nowrap;">${new Date(job.created_at + 'Z').toLocaleString()}</td>
    <td>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">`;

// Cancel button
const canCancel = ['RUNNING','PENDING','IN_PROGRESS'].includes(job.status);
if (canCancel) {
  html += `<button onclick="cancelJob('${job.job_id}')" class="btn btn-sm btn-danger">âŒ Cancel</button>`;
}

// Download button
if ((job.status || '').startsWith('COMPLETED')) {
  html += `<button onclick="downloadJobReport('${job.job_id}')" class="btn btn-sm btn-success">ğŸ“¥</button>`;
}

html += `<button class="btn btn-sm btn-secondary" onclick="viewJobDetails('${job.job_id}')">ğŸ‘ï¸</button>
         <button class="btn btn-sm btn-danger" onclick="deleteJob('${job.job_id}')" title="Delete Job">ğŸ—‘ï¸</button>
      </div>
    </td>
  </tr>`;
});

      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function viewJobDetails(job_id) {
      try {
        const { response, result } = await apiCall(`${APP_CONFIG.JOBS_API}/${job_id}`);
        
        if (response.ok && result.data) {
          const job = result.data;
          
          let content = `
            <div style="line-height: 1.8;">
              <p><strong>Job ID:</strong> ${job.job_id}</p>
              <p><strong>Status:</strong> <span class="status-badge ${job.status === 'COMPLETED' ? 'success' : 'info'}">${job.status}</span></p>
              <p><strong>Identifier Type:</strong> ${job.identifier_type}</p>
              <p><strong>Filename:</strong> ${job.filename}</p>
              <p><strong>Created By:</strong> ${job.created_by}</p>
              <p><strong>Total Subscribers:</strong> ${job.total_subscribers}</p>
              <p><strong>Successfully Migrated:</strong> ${job.migrated_count}</p>
              <p><strong>Failed:</strong> ${job.failed_count}</p>
              <p><strong>Progress:</strong> ${job.progress}%</p>
              <p><strong>Created At:</strong> ${new Date(job.created_at + 'Z').toLocaleString()}</p>
              ${job.completed_at ? `<p><strong>Completed At:</strong> ${new Date(job.completed_at + 'Z').toLocaleString()}</p>` : ''}
            </div>
          `;
          
          if ((job.status || '').startsWith('COMPLETED')) {
            content += `<button class="btn" onclick="downloadReport('${job.job_id}')" style="margin-top: 16px;">ğŸ“¥ Download Full Report</button>`;
          }
          
          document.getElementById('modal-job-title').textContent = `Job Details: ${job_id}`;
          document.getElementById('modal-job-content').innerHTML = content;
          document.getElementById('job-modal').style.display = 'flex';
        }
      } catch (error) {
        showNotification('Failed to load job details', 'error');
      }
    }

    async function downloadReport(job_id) {
      try {
        // Use fetch directly for blob response
        const response = await fetch(`${APP_CONFIG.JOBS_API}/${job_id}/report`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `migration_report_${job_id}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          showNotification('Report downloaded successfully!', 'success');
        } else {
          throw new Error('Download failed');
        }
      } catch (error) {
        showNotification('Failed to download report', 'error');
      }
    }

    function closeJobModal() {
      document.getElementById('job-modal').style.display = 'none';
    }

// === DATA QUERY ===
Â  Â  async function executeQuery() {
Â  Â  Â  const queryType = document.getElementById('query-type-select').value;
Â  Â  Â  const queryValue = document.getElementById('query-value-input').value.trim();
	Â  const dataSource = document.getElementById('query-source-select').value;
Â  Â  Â Â 
Â  Â  Â  if (!queryValue) {
Â  Â  Â  Â  showNotification('Please enter a query value', 'error');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const container = document.getElementById('query-results-container');
Â  Â  Â  container.innerHTML = '<div class="alert info">ğŸ” Executing query...</div>';
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  const { response, result } = await apiCall(APP_CONFIG.QUERY_API, {
Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  query_type: queryType,
Â  Â  Â  Â  Â  Â  query_value: queryValue,
Â  Â  Â  Â  Â  Â  data_source: dataSource
Â  Â  Â  Â  Â  })
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (response.ok && result.data) {
Â  Â  Â  Â  Â  displayQueryResults(result.data.results, container);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  throw new Error(result.message || 'Query failed');
Â  Â  Â  Â  }
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  container.innerHTML = `<div class="alert error">âŒ ${error.message}</div>`;
Â  Â  Â  }
Â  Â  }

Â  Â  function displayQueryResults(results, container) {
Â  Â  Â  if (!results || results.length === 0) {
Â  Â  Â  Â  container.innerHTML = '<div class="alert info">No results found</div>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  let html = `<div class="alert success">âœ… Found ${results.length} result(s)</div>`;
Â  Â  Â  html += '<table class="results-table">';
Â  Â  Â  html += '<thead><tr>';
Â  Â  Â  html += '<th>UID</th><th>IMSI</th><th>MSISDN</th><th>Email</th><th>Status</th><th>Plan</th><th>Source</th><th>Created</th>';
Â  Â  Â  html += '</tr></thead><tbody>';

Â  Â  Â  results.forEach(sub => {
Â  Â  Â  Â  html += `<tr>
Â  Â  <td><strong>${sub.uid || '-'}</strong></td>
Â  Â  <td>${sub.imsi || '-'}</td>
Â  Â  <td>${sub.msisdn || '-'}</td>
Â  Â  <td>${sub.email || '-'}</td>
Â  Â  <td><span class="status-badge ${sub.status === 'ACTIVE' ? 'success' : 'warning'}">${sub.status || 'N/A'}</span></td>
Â  Â  <td>${sub.plan || sub.plan_id || '-'}</td>
Â  Â  <td>${sub._source || '-'}</td>
Â  Â  <td>${sub.created_at ? new Date(sub.created_at + 'Z').toLocaleString() : '-'}</td>
Â  Â 
Â  Â  </tr>`;
Â  Â  Â  });

Â  Â  Â  html += '</tbody></table>';
Â  Â  Â  container.innerHTML = html;
Â  Â  }


    // === PERFORMANCE DASHBOARD ===
    async function loadPerformance() {
      const container = document.getElementById('performance-metrics-container');
      
      try {
        const { response, result } = await apiCall('/api/dashboard/performance');
        
        if (response.ok && result.data) {
          displayPerformanceMetrics(result.data, container);
        } else {
          throw new Error(result.message || 'Failed to load metrics');
        }
      } catch (error) {
        container.innerHTML = `<div class="alert error">âŒ ${error.message}</div>`;
      }
    }

    function displayPerformanceMetrics(metrics, container) {
      const stats = metrics.migration_stats;
      
      let html = '<div class="stats-grid">';
      
      html += `
        <div class="stat-card">
          <h3>Total Jobs</h3>
          <div class="stat-number" style="color: var(--color-primary);">${stats.total_jobs}</div>
        </div>
        <div class="stat-card">
          <h3>Completed</h3>
          <div class="stat-number" style="color: var(--color-success);">${stats.completed_jobs}</div>
        </div>
        <div class="stat-card">
          <h3>Failed</h3>
          <div class="stat-number" style="color: var(--color-danger);">${stats.failed_jobs}</div>
        </div>
        <div class="stat-card">
          <h3>In Progress</h3>
          <div class="stat-number" style="color: var(--color-info);">${stats.in_progress_jobs}</div>
        </div>
      `;
      
      html += '</div>';
      
      html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">';
      
      html += `
        <div class="card">
          <h3>Migration Summary</h3>
          <p><strong>Total Migrated:</strong> ${stats.total_migrated}</p>
          <p><strong>Total Failed:</strong> ${stats.total_failed}</p>
          <p><strong>Success Rate:</strong> ${stats.total_jobs > 0 ? Math.round((stats.completed_jobs / stats.total_jobs) * 100) : 0}%</p>
        </div>
        
        <div class="card">
          <h3>System Health</h3>
          <p><strong>Database:</strong> <span class="status-badge success">${metrics.system_health.database_status}</span></p>
          <p><strong>API:</strong> <span class="status-badge success">${metrics.system_health.api_status}</span></p>
        </div>
      `;
      
      html += '</div>';
      
      container.innerHTML = html;
    }

    // === UI NAVIGATION ===
	function persistPage(pageId){ try{ localStorage.setItem('lastPage', pageId); }catch{} }
    function showPage(pageId) {
	  clearPageContext();
      document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      
      const section = document.getElementById(pageId);
      if (section) section.classList.add('active');
      
      const navItem = document.querySelector(`[data-page="${pageId}"]`);
      if (navItem) navItem.classList.add('active');
     
	 // remember selection
	  localStorage.setItem('last-page', pageId);
	  
      // Load page-specific data
      if (pageId === 'dashboard') { loadDashboard(); }
      if (pageId === 'migration') { refreshJobs(); }
      if (pageId === 'provisioning') { settings.load(); } // Load mode for provisioning page
      if (pageId === 'query') { /* No auto-load */ }
      if (pageId === 'monitoring') { loadPerformance(); }
      if (pageId === 'settings') { settings.load(); }
	  if (pageId === 'bulk-delete') { refreshDeletionJobs(); }
	  
	  persistPage(pageId);
	  
    }
    
    // === MODAL UTILITY ===
    function showConfirmationModal(title, message, onConfirm) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-message').textContent = message;
      const modal = document.getElementById('confirmation-modal');
      modal.style.display = 'flex';
      const confirmBtn = document.getElementById('modal-confirm');
      const cancelBtn = document.getElementById('modal-cancel');

      const confirmHandler = () => { onConfirm(); closeHandler(); };
      const closeHandler = () => {
        modal.style.display = 'none';
        confirmBtn.removeEventListener('click', confirmHandler);
        cancelBtn.removeEventListener('click', closeHandler);
      };
      
      // Clear old listeners before adding new ones
      confirmBtn.replaceWith(confirmBtn.cloneNode(true));
      cancelBtn.replaceWith(cancelBtn.cloneNode(true));
      
      document.getElementById('modal-confirm').addEventListener('click', confirmHandler);
      document.getElementById('modal-cancel').addEventListener('click', closeHandler);
    }

    // === MIGRATION OPERATIONS (STUBS) ===
    const migration = {
      async startBulk() {
        showNotification('ğŸš€ Bulk migration feature - not implemented', 'info');
      },
      async checkJobs() {
        refreshJobs();
      },
      async loadHistory() {
        refreshJobs();
      },
      async cancelAll() {
        showNotification('ğŸ›‘ Cancel all feature - not implemented', 'warning');
      }
    };

    // === PROVISIONING (FIXED: MERGED OLD AND NEW LOGIC) ===
    const provisioning = {
      // Point to the global createSubscriber function
      create: () => createSubscriber(),
      
      // Use the new form's clear function
      clearForm() {
        document.getElementById('create-uid').value = '';
        document.getElementById('create-imsi').value = '';
        document.getElementById('create-msisdn').value = '';
        document.getElementById('create-email').value = '';
        document.getElementById('create-plan').value = '';
        document.getElementById('create-status').value = 'ACTIVE';
        document.getElementById('create-subscriber-status').innerHTML = '';
      },
      
      // Load all stub
      loadAll() {
        showNotification('ğŸ“‹ Load all feature - implement pagination', 'info');
      },
      
      // Point "Edit" button to the searchForModify function
      edit(uid) {
        document.getElementById('modify-search-uid').value = uid;
        searchForModify();
        showNotification(`Loading ${uid} for modification...`, 'info');
      },

// Search function from old file, adapted for new API
      async search() {
        const query = document.getElementById('search-input').value.trim();
        const currentMode = document.getElementById('provisioning-mode').value;
        const resultsEl = document.getElementById('search-results');
        
        if (!query) {
          showNotification('Please enter a search term', 'error');
          return;
        }
        
        resultsEl.innerHTML = `<div class="alert info">ğŸ” Searching...</div>`;
        
        try { // <-- TRY block starts here
          if (currentMode === 'HYBRID') {
            await this.hybridCloudFirstSearch(query, resultsEl);
          } else if (currentMode === 'CLOUD') {
            const { result } = await this.searchCloudOnly(query);
            this.displayResults(result.data.subscribers || [], query, resultsEl);
          } else if (currentMode === 'LEGACY') {
            const { result } = await this.searchLegacyOnly(query);
            this.displayResults(result.data.subscribers || [], query, resultsEl);
          }
        } catch (error) { // <-- CATCH block is here
           resultsEl.innerHTML = `<div class="alert error">âŒ Search failed: ${error.message}</div>`;
        }
      },
	  
	  
      async hybridCloudFirstSearch(queryText, resultsEl) {
        try {
          resultsEl.innerHTML = `<div class="alert info">ğŸ” Searching Cloud first...</div>`;
          const { result: cloudResult } = await this.searchCloudOnly(queryText);
          const cloudSubs = cloudResult.data.subscribers || [];
          
          if (cloudSubs.length > 0) {
            resultsEl.innerHTML = `<div class="alert success">âœ… Found ${cloudSubs.length} in Cloud</div>`;
            this.displayResults(cloudSubs, queryText, resultsEl);
            return;
          }
          
          resultsEl.innerHTML = `<div class="alert warning">âš ï¸ Not in Cloud, trying Legacy...</div>`;
          const { result: legacyResult } = await this.searchLegacyOnly(queryText);
          const legacySubs = legacyResult.data.subscribers || [];
          
          if (legacySubs.length > 0) {
            resultsEl.innerHTML = `<div class="alert warning">âš ï¸ Found ${legacySubs.length} in Legacy only</div>`;
            this.displayResults(legacySubs, queryText, resultsEl);
          } else {
            resultsEl.innerHTML = `<div class="state-container"><div class="icon">ğŸ”</div><h3>No Results Found</h3><p>Not found in either system for "${queryText}".</p></div>`;
          }
        } catch (error) {
          resultsEl.innerHTML = `<div class="alert error">âŒ Search failed: ${error.message}</div>`;
        }
      },

      // --- API Calls (fixed to use apiCall) ---
      async searchCloudOnly(queryText) {
        return apiCall(`${APP_CONFIG.SUBSCRIBERS_API}/search?q=${encodeURIComponent(queryText)}&system=cloud`);
      },
      async searchLegacyOnly(queryText) {
        return apiCall(`${APP_CONFIG.SUBSCRIBERS_API}/search?q=${encodeURIComponent(queryText)}&system=legacy`);
      },
      async checkUidInCloud(uid) {
        try {
          const { response } = await apiCall(`${APP_CONFIG.SUBSCRIBERS_API}/${uid}?system=cloud`);
          return response.ok && response.status !== 404;
        } catch (e) { return false; }
      },
      async checkUidInLegacy(uid) {
         try {
          const { response } = await apiCall(`${APP_CONFIG.SUBSCRIBERS_API}/${uid}?system=legacy`);
          return response.ok && response.status !== 404;
        } catch (e) { return false; }
      },
      
      // --- Display & Delete (from old file) ---
      displayResults(data, query, resultsEl) {
        if (!data || !Array.isArray(data) || data.length === 0) {
          resultsEl.innerHTML = `
            <div class="state-container">
              <div class="icon">ğŸ”</div>
              <h3>No Results Found</h3>
              <p>No subscribers found for "${query}". Try a different search term.</p>
            </div>`;
          return;
        }
        resultsEl.innerHTML = `
          <h3>ğŸ” Search Results (${data.length} found)</h3>
          <table class="results-table">
            <thead>
              <tr><th>Subscriber ID</th><th>IMSI</th><th>MSISDN</th><th>Email</th><th>Plan</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody>
              ${data.map(sub => `
                <tr>
                  <td><strong>${sub.uid || 'N/A'}</strong></td>
				  <td>${sub.imsi ?? sub.IMSI ?? '-'}</td>
		    	  <td>${sub.msisdn ?? sub.MSISDN ?? '-'}</td>
                  <td>${sub.email || 'N/A'}</td>
                  <td><span class="status-badge info">${sub.plan_id || sub.plan || 'N/A'}</span></td>
                  <td><span class="status-badge ${sub.status === 'ACTIVE' ? 'success' : 'warning'}">${sub.status || 'N/A'}</span></td>
                  <td>
                    <button class="btn btn-sm btn-secondary" onclick="provisioning.edit('${sub.uid}')">âœï¸ Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="provisioning.confirmDelete('${sub.uid}')" style="margin-left: 8px;">ğŸ—‘ï¸ Delete</button>
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>`;
        showNotification(`âœ… Found ${data.length} subscribers`, 'success');
      },

      confirmDelete(uid) {
        showConfirmationModal('Delete Subscriber', `Are you sure you want to permanently delete subscriber ${uid}? This action cannot be undone.`, () => this.delete(uid));
      },

      async delete(uid) {
        const currentMode = document.getElementById('provisioning-mode').value;
        try {
          if (currentMode === 'HYBRID') {
            await this.hybridDelete(uid);
          } else if (currentMode === 'CLOUD') {
            await this.deleteFromCloudOnly(uid);
          } else if (currentMode === 'LEGACY') {
            await this.deleteFromLegacyOnly(uid);
          }
          this.search(); // Refresh results
        } catch (error) {
          showNotification(`Delete failed: ${error.message}`, 'error');
        }
      },

      async hybridDelete(uid) {
        const cloudExists = await this.checkUidInCloud(uid);
        const legacyExists = await this.checkUidInLegacy(uid);
        if (!cloudExists && !legacyExists) throw new Error(`UID ${uid} not found in either system`);
        
        let results = [];
        if (cloudExists) {
          try {
            await this.deleteFromCloudOnly(uid);
            results.push('âœ… Cloud');
          } catch (e) { results.push('âŒ Cloud'); }
        }
        if (legacyExists) {
           try {
            await this.deleteFromLegacyOnly(uid);
            results.push('âœ… Legacy');
          } catch (e) { results.push('âŒ Legacy'); }
        }
        showNotification(`Hybrid Delete: ${results.join(', ')}`, 'success');
      },

      async deleteFromCloudOnly(uid) {
        const { response } = await apiCall(`${APP_CONFIG.SUBSCRIBERS_API}/${uid}?system=cloud`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Cloud delete failed');
        showNotification(`â˜ï¸ UID ${uid} deleted from Cloud`, 'success');
      },

      async deleteFromLegacyOnly(uid) {
        const { response } = await apiCall(`${APP_CONFIG.SUBSCRIBERS_API}/${uid}?system=legacy`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Legacy delete failed');
        showNotification(`ğŸ›ï¸ UID ${uid} deleted from Legacy`, 'success');
      }
    };

    // === MONITORING ===
    const monitoring = {
      realtimeActive: false,
      refresh: loadPerformance,
      async checkHealth() {
        await testAPI();
      },
      toggleRealtime() {
        const btn = document.getElementById('realtime-btn');
        if (this.realtimeActive) {
          this.realtimeActive = false;
          btn.textContent = 'ğŸ“¡ Start Live Monitor';
          showNotification('â¹ï¸ Real-time monitoring stopped', 'info');
        } else {
          this.realtimeActive = true;
          btn.textContent = 'â¹ï¸ Stop Live Monitor';
          showNotification('ğŸ“¡ Real-time monitoring started', 'success');
          const loop = () => {
            if (!this.realtimeActive) return;
            this.refresh();
            setTimeout(loop, 5000);
          };
          loop();
        }
      }
    };

    // === SETTINGS ===
    const settings = {
      async load() {
  // Load provisioning mode from backend
  try {
    const { response, result } = await apiCall(`${APP_CONFIG.SETTINGS_API}/provisioning-mode`);
    if (response.ok && result.data && result.data.mode) {
       document.getElementById('provisioning-mode').value = result.data.mode;
       localStorage.setItem('provisioning-mode', result.data.mode);
    }
  } catch (e) {
    console.warn('Could not load settings from backend, using localStorage.');
    const savedMode = localStorage.getItem('provisioning-mode') || 'CLOUD';
    document.getElementById('provisioning-mode').value = savedMode;
  }

  // Load system parameters from localStorage
  document.getElementById('setting-batch-size').value = localStorage.getItem('setting-batch-size') || '1000';
  document.getElementById('setting-api-timeout').value = localStorage.getItem('setting-api-timeout') || '30';
  document.getElementById('setting-max-jobs').value = localStorage.getItem('setting-max-jobs') || '3';
  document.getElementById('setting-log-retention').value = localStorage.getItem('setting-log-retention') || '30';
},

    async saveMode() {
        const mode = document.getElementById('provisioning-mode').value;
        localStorage.setItem('provisioning-mode', mode);
        
        // Try to save to backend
        try {
           const { response, result } = await apiCall(`${APP_CONFIG.SETTINGS_API}/provisioning-mode`, {
             method: 'POST',
             body: JSON.stringify({ mode: mode })
           });
           if (!response.ok) throw new Error(result.message);
           showNotification('ğŸ’¾ Provisioning mode saved: ' + mode, 'success');
		   
		   // âœ… RELOAD DASHBOARD IF ON DASHBOARD PAGE
		   
           loadDashboard();
          
		   
        } catch (e) {
           showNotification('ğŸ’¾ Mode saved locally (backend sync failed)', 'warning');
        }
      },
      saveConfig() {
	    localStorage.setItem('setting-batch-size', document.getElementById('setting-batch-size').value);
        localStorage.setItem('setting-api-timeout', document.getElementById('setting-api-timeout').value);
        localStorage.setItem('setting-max-jobs', document.getElementById('setting-max-jobs').value);
        localStorage.setItem('setting-log-retention', document.getElementById('setting-log-retention').value);
        showNotification('ğŸ’¾ System parameters saved', 'success');
      }
    }

    // === CREATE SUBSCRIBER (Global Function) ===
    async function createSubscriber() {
      const uid = document.getElementById('create-uid').value.trim();
      const imsi = document.getElementById('create-imsi').value.trim();
      const msisdn = document.getElementById('create-msisdn').value.trim();
      const email = document.getElementById('create-email').value.trim();
      const status = document.getElementById('create-status').value;
      const plan = document.getElementById('create-plan').value.trim();
      
      if (!uid || !imsi || !msisdn) {
        showNotification('UID, IMSI, and MSISDN are required', 'error');
        return;
      }
      
      const statusEl = document.getElementById('create-subscriber-status');
      statusEl.innerHTML = '<div class="alert info">Creating subscriber...</div>';
      
      try {
        // FIXED: Call the correct /api/subscribers endpoint
        const { response, result } = await apiCall(APP_CONFIG.SUBSCRIBERS_API, {
          method: 'POST',
          body: JSON.stringify({
            uid: uid,
            imsi: imsi,
            msisdn: msisdn,
            email: email,
            status: status,
            plan: plan
          })
        });
        
        if (response.ok) {
          statusEl.innerHTML = '<div class="alert success">âœ… Subscriber created successfully!</div>';
          showNotification('Subscriber created successfully!', 'success');
          
          provisioning.clearForm(); // Use the correct clear function
          
          setTimeout(() => statusEl.innerHTML = '', 3000);
        } else {
          throw new Error(result.message || 'Create failed');
        }
      } catch (error) {
        statusEl.innerHTML = `<div class="alert error">âŒ ${error.message}</div>`;
        showNotification('Failed to create subscriber', 'error');
      }
    }

// === SEARCH FOR MODIFY (Global Function) ===
async function searchForModify(uidToSearch) {
  const uid = uidToSearch || document.getElementById('modify-search-uid').value.trim();
  if (!uid) { showNotification('Please enter UID', 'error'); return; }

  // derive data_source from provisioning mode
  const mode = document.getElementById('provisioning-mode').value; // CLOUD | LEGACY | HYBRID
  const data_source = (mode === 'HYBRID') ? 'both' : mode.toLowerCase();

  try {
    const { response, result } = await apiCall(APP_CONFIG.QUERY_API, {
      method: 'POST',
      body: JSON.stringify({ query_type: 'uid', query_value: uid, data_source })
    });

    if (response.ok && result.data && result.data.results && result.data.results.length > 0) {
      const subscriber = result.data.results[0];

      // remember which system this record came from so PUT goes to the right place
      const source = subscriber._source || (mode === 'LEGACY' ? 'legacy' : 'cloud');
      document.getElementById('modify-form-container').dataset.source = source;

      // populate form
      document.getElementById('modify-uid').value    = subscriber.uid    || '';
      document.getElementById('modify-imsi').value   = subscriber.imsi   || '';
      document.getElementById('modify-msisdn').value = subscriber.msisdn || '';
      document.getElementById('modify-email').value  = subscriber.email  || '';
      document.getElementById('modify-status').value = subscriber.status || 'ACTIVE';
      document.getElementById('modify-plan').value   = subscriber.plan   || '';

      document.getElementById('modify-form-container').style.display = 'block';
      showNotification('Subscriber found! Modify the fields below.', 'success');
    } else {
      showNotification('Subscriber not found in selected source(s)', 'error');
      document.getElementById('modify-form-container').style.display = 'none';
    }
  } catch (error) {
    showNotification('Search failed: ' + error.message, 'error');
  }
}


    // === MODIFY SUBSCRIBER (Global Function) ===
    async function modifySubscriber() {
      const uid = document.getElementById('modify-uid').value.trim();
      const imsi = document.getElementById('modify-imsi').value.trim();
      const msisdn = document.getElementById('modify-msisdn').value.trim();
      const email = document.getElementById('modify-email').value.trim();
      const status = document.getElementById('modify-status').value;
      const plan = document.getElementById('modify-plan').value.trim();
      
      if (!uid) {
        showNotification('UID is required', 'error');
        return;
      }
      
      const statusEl = document.getElementById('modify-subscriber-status');
      statusEl.innerHTML = '<div class="alert info">Updating subscriber...</div>';
      
      try {
        // FIXED: Call the correct /api/subscribers/:uid endpoint
        const source = document.getElementById('modify-form-container').dataset.source || 'cloud';
        const { response, result } = await apiCall(`${APP_CONFIG.SUBSCRIBERS_API}/${uid}?system=${source}`, {
          method: 'PUT',
          body: JSON.stringify({
            uid: uid,
            imsi: imsi,
            msisdn: msisdn,
            email: email,
            status: status,
            plan: plan
          })
        });
        
        if (response.ok) {
          statusEl.innerHTML = '<div class="alert success">âœ… Subscriber updated successfully!</div>';
          showNotification('Subscriber updated successfully!', 'success');
          
          setTimeout(() => {
            statusEl.innerHTML = '';
            document.getElementById('modify-form-container').style.display = 'none';
            document.getElementById('modify-search-uid').value = '';
          }, 3000);
        } else {
          throw new Error(result.message || 'Update failed');
        }
      } catch (error) {
        statusEl.innerHTML = `<div class="alert error">âŒ ${error.message}</div>`;
        showNotification('Failed to update subscriber', 'error');
      }
    }

    // === UTILITIES ===
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `alert ${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 3000;
        max-width: 400px; box-shadow: var(--shadow-lg);
      `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 4000);
    }

// === INIT ===
Â  Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  document.getElementById('login-btn').addEventListener('click', login);
Â  Â  Â  document.getElementById('logout-btn').addEventListener('click', logout);
Â  Â  Â Â 
Â  Â  Â  document.querySelectorAll('.nav-item').forEach(item => {
Â  Â  Â  Â  item.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  const page = e.currentTarget.dataset.page;
Â  Â  Â  Â  Â  if (page) showPage(page);
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // Enter key for login
Â  Â  Â  document.getElementById('password').addEventListener('keypress', (e) => {
Â  Â  Â  Â  if (e.key === 'Enter') login();
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // Auto-refresh jobs every 30 seconds
Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  const token = localStorage.getItem('authToken'); // Corrected
Â  Â  Â  Â  if (token && document.getElementById('migration').classList.contains('active')) {
Â  Â  Â  Â  Â  refreshJobs();
Â  Â  Â  Â  }
Â  Â  Â  Â  if (token && document.getElementById('monitoring').classList.contains('active')) {
Â  Â  Â  Â  Â  loadPerformance();
Â  Â  Â  Â  }
Â  Â  Â  }, APP_CONFIG.REFRESH_INTERVAL);
Â  Â  Â Â 
      // --- THIS IS THE FIX ---
Â  Â  Â  checkAuth(); // Check if we are logged in
      
      // If we are logged in, load the last page and all core data
      if (authToken) { 
        const last = localStorage.getItem('lastPage') || 'dashboard';
        showPage(last);
        refreshJobs(); // Load jobs
        settings.load(); // Load settings
      }
Â  Â  });
	
	
    // CANCEL JOB
    async function cancelJob(job_id) {
      if (!confirm('Are you sure you want to cancel this job?')) return;
      
      try {
        const { response, result } = await apiCall(`/api/migration/jobs/${job_id}/cancel`, { method: 'POST' });
        showNotification('Job cancelled successfully', 'success');  // âœ… Correct function

        refreshJobs();
      } catch (error) {
        showNotification('Failed to cancel job: ' + error.message, 'error');  // âœ…
      }
    }

    // DOWNLOAD JOB REPORT
    async function downloadJobReport(job_id) {
      try {
        const { response, result } = await apiCall(`/api/migration/jobs/${job_id}/report`);
        if (result.data && result.data.download_url) {
        const a = document.createElement('a');
        a.href = result.data.download_url;
        a.download = result.data.report_filename || `report_${job_id}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        showNotification('Report download started', 'success');
        } else {
          showNotification('Report not available', 'warning');  // âœ…
        }
      } catch (error) {
        showNotification('Failed to download report: ' + error.message, 'error');  // âœ… Correct
      }
    }

// DELETE JOB
async function deleteJob(job_id) {
  // Use the confirmation modal
  showConfirmationModal(
    'Delete Job',
    `Are you sure you want to permanently delete job ${job_id}? This cannot be undone.`,
    async () => {
      try {
        const { response, result } = await apiCall(`/api/migration/jobs/${job_id}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          showNotification(`Job ${job_id} deleted successfully`, 'success');

          // Refresh the correct list
          if (document.getElementById('migration').classList.contains('active')) {
            refreshJobs();
          } else if (document.getElementById('bulk-delete').classList.contains('active')) {
            refreshDeletionJobs();
          }
        } else {
          throw new Error(result.message || 'Failed to delete');
        }
      } catch (error) {
        showNotification('Failed to delete job: ' + error.message, 'error');
      }
    }
  );
}



    // BULK DELETE
    async function executeBulkDelete() {
      const fileInput = document.getElementById('bulk-delete-file');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a CSV file');
        return;
      }
      
      if (!confirm('âš ï¸ This will PERMANENTLY DELETE subscribers from DynamoDB. Continue?')) return;
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        const csvContent = e.target.result;
        
        try {
           const { response, result } = await apiCall('/api/migration/bulk-delete', {
           method: 'POST',
           body: JSON.stringify({ file: csvContent })
           });

        showNotification(`Bulk delete job started: ${result.data.job_id}`, 'success');
          
          
          showPage('bulk-delete');
		  refreshDeletionJobs();
        } catch (error) {
          showNotification('Bulk delete failed: ' + error.message, 'error');  // âœ… Correct
        }
      };
      
      reader.readAsText(file);
    }

// === DELETION JOBS LIST ===
async function refreshDeletionJobs() {
  try {
    const { response, result } = await apiCall('/api/migration/jobs');
    if (!response.ok) return;

    // Filter only deletion jobs
    const deletionJobs = (result.data.jobs || []).filter(job => job.job_type === 'bulk_delete');
    const container = document.getElementById('deletion-jobs-list');
    if (deletionJobs.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-light);">No deletion jobs found</p>';
      return;
    }

    let html = '<table class="table"><thead><tr>' +
      '<th>Job ID</th>' +
      '<th>Status</th>' +
      '<th>Total</th>' +
      '<th>Deleted</th>' +
      '<th>Failed</th>' +
      '<th>Progress</th>' +
      '<th>Created</th>' +
      '<th>Actions</th>' +
      '</tr></thead><tbody>';

    deletionJobs.forEach(job => {
      const statusClass = (job.status || '').startsWith('COMPLETED') ? 'success' : 
                          (job.status === 'FAILED' || (job.status || '').includes('ERROR')) ? 'error' : 'info';

      html += `<tr>
        <td><strong>${job.job_id}</strong></td>
        <td><span class="status-badge ${statusClass}">${job.status}</span></td>
        <td>${job.total_items || 0}</td>
        <td style="color: var(--color-success);">${job.successful_items || 0}</td>
        <td style="color: var(--color-danger);">${job.failed_items || 0}</td>
        <td>
          <div class="progress-bar" style="width: 80px;">
            <div class="progress-fill" style="width: ${job.progress || 0}%;"></div>
          </div>
          <small>${job.progress || 0}%</small>
        </td>
        <td style="font-size: 12px;">${new Date(job.created_at + 'Z').toLocaleString()}</td>
        <td>
          <div style="display: flex; gap: 8px;">`;

      // Cancel button
      if (job.status === 'IN_PROGRESS') {
        html += `<button onclick="cancelJob('${job.job_id}')" class="btn btn-sm btn-danger">âŒ</button>`;
      }
      
      // Download button
      if ((job.status || '').startsWith('COMPLETED')) {
        html += `<button onclick="downloadJobReport('${job.job_id}')" class="btn btn-sm btn-success">ğŸ“¥</button>`;
      }

      // ADDED DELETE BUTTON
      html += `<button class="btn btn-sm btn-danger" onclick="deleteJob('${job.job_id}')" title="Delete Job">ğŸ—‘ï¸</button>`;

      html += `</div>
        </td>
      </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;

  } catch (error) {
    // Handle/display error
    console.error('Error loading deletion jobs', error);
    const container = document.getElementById('deletion-jobs-list');
    if (container)
      container.innerHTML = `<div class="alert error">âŒ Error loading deletion jobs: ${error.message || error}</div>`;
  }
}


// === QUICK QUERY TEMPLATES ===
function loadQuickQuery(queryType) {
  const modeEl = document.getElementById('provisioning-mode');
  const inputEl = document.getElementById('sql-query-input');

  if (!modeEl || !inputEl) {
    console.error('Missing required elements: #provisioning-mode or #sql-query-input');
    showNotification('Internal error: UI controls missing', 'error');
    return;
  }

  const mode = String(modeEl.value || '').toUpperCase(); // e.g., LEGACY / CLOUD / HYBRID
  const isLegacy = (mode === 'LEGACY');

  const queries_sql = {
    all: 'SELECT * FROM subscribers LIMIT 1000',
    uid: 'SELECT uid, imsi, msisdn, status, created_at FROM subscribers ORDER BY created_at DESC',
    active: "SELECT * FROM subscribers WHERE status = 'ACTIVE' LIMIT 1000",
    recent: 'SELECT * FROM subscribers WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) ORDER BY created_at DESC',
    contacts: 'SELECT uid, imsi, msisdn, email FROM subscribers ORDER BY created_at DESC LIMIT 1000'
  };

  const sevenDaysAgoIso = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

  const queries_partiql = {
    all: 'SELECT * FROM subscribers LIMIT 1000',
    uid: 'SELECT uid FROM subscribers',
    active: "SELECT * FROM subscribers WHERE status = 'ACTIVE' LIMIT 1000",
    recent: `SELECT * FROM subscribers WHERE created_at >= '${sevenDaysAgoIso}'`,
    contacts: 'SELECT uid, imsi, msisdn, email FROM subscribers LIMIT 1000'
  };

  const map = isLegacy ? queries_sql : queries_partiql;
  const query = map[queryType];

  if (!query) {
    showNotification(`Unknown quick query type: ${queryType}`, 'warning');
    return;
  }

  inputEl.value = query;
  showNotification(`Quick query loaded for ${mode} mode`, 'info');
}

// SQL EXPORT
async function executeSQLExport() {
  const query = document.getElementById('sql-query-input').value.trim();
  const resultDiv = document.getElementById('sql-export-result');
  const currentMode = document.getElementById('provisioning-mode').value;

  if (!query) {
    alert('Please enter a SQL query');
    return;
  }

  if (!query.toLowerCase().startsWith('select')) {
    alert('Only SELECT queries are allowed');
    return;
  }

  resultDiv.innerHTML = '<p style="text-align: center;">â³ Executing query...</p>';

  try {
    const { response, result } = await apiCall('/api/migration/sql-export', {
      method: 'POST',
      body: JSON.stringify({
      query: query,
      mode: currentMode  
  })
});

    if (result.data && (result.data.download_url || result.data.downloadurl)) {
      const url = result.data.download_url || result.data.downloadurl;
      // prefer in-page download (no redirect)
      const a = document.createElement('a');
      a.href = url;
      a.download = result.data.report_filename || 'export.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      resultDiv.innerHTML = `
        <div class="alert success">âœ… Download started. If it didn't, <a href="${url}" download>click here</a>.</div>
        <p><strong>Rows:</strong> ${result.data.row_count || 0}</p>
      `;
    } else {
      resultDiv.innerHTML = `<div class="alert error">âŒ ${result.message || 'Export failed'}</div>`;
      showNotification('Export failed', 'error');
    }
  } catch (error) {
    resultDiv.innerHTML = `<div class="alert error">âŒ Error: ${error.message}</div>`;
    showNotification('Export failed', 'error');
  }
}


// Clear migration page status

function clearPageContext() {
  // Clear migration page status
  const csvStatus = document.getElementById('csv-upload-status');
  if (csvStatus) csvStatus.innerHTML = '';
  const csvInput = document.getElementById('csv-file-input');
  if (csvInput) csvInput.value = '';

  // Clear bulk delete page status
  const delStatus = document.getElementById('bulk-delete-result');
  if (delStatus) delStatus.innerHTML = '';
  const delInput = document.getElementById('bulk-delete-file');
  if (delInput) delInput.value = '';

  // Clear SQL export page
  const sqlStatus = document.getElementById('sql-export-result');
  if (sqlStatus) sqlStatus.innerHTML = '';
  const sqlInput = document.getElementById('sql-query-input');
  // --- THIS IS THE FIX ---
  if (sqlInput) sqlInput.value = ""; 

  // Clear provisioning page
  const createStatus = document.getElementById('create-subscriber-status');
  if (createStatus) createStatus.innerHTML = '';
  const modifyStatus = document.getElementById('modify-subscriber-status');
  if (modifyStatus) modifyStatus.innerHTML = '';
  const searchResults = document.getElementById('search-results');
  if (searchResults) searchResults.innerHTML = '';

  // Clear query page
  const queryResults = document.getElementById('query-results-container');
  if (queryResults) queryResults.innerHTML = '';
}



</script>
</body>
</html>