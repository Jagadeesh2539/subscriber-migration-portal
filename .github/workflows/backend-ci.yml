name: âš™ï¸ Backend CI

on:
  pull_request:
    paths: ['backend/**', '.github/workflows/**']
  push:
    branches: [develop, feature/*]
    paths: ['backend/**']

env:
  PYTHON_VERSION: '3.11'
  AWS_REGION: us-east-1

jobs:
  lint-and-test:
    name: ğŸ” Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: ğŸ“¥ Install Development Dependencies
        run: |
          pip install flake8 black isort pytest
          cd backend
          pip install -r requirements.txt
          
      - name: ğŸ¨ Code Formatting Check
        run: |
          cd backend
          echo "ğŸ¨ Checking code formatting with Black..."
          black --check --diff app.py || true
          
      - name: ğŸ“‹ Import Sorting Check
        run: |
          cd backend
          echo "ğŸ“‹ Checking import sorting..."
          isort --check-only --diff app.py || true
          
      - name: ğŸ” Lint with flake8
        run: |
          cd backend
          echo "ğŸ” Running flake8 linting..."
          flake8 app.py --max-line-length=120 --ignore=E501,W503,E203 || true
          
      - name: ğŸ” Syntax Check
        run: |
          cd backend
          echo "ğŸ” Checking Python syntax..."
          python -m py_compile app.py
          echo "âœ… Syntax check passed"
          
      - name: ğŸ“¦ Test Package Build
        run: |
          cd backend
          echo "ğŸ“¦ Testing package build..."
          
          # Create test package
          mkdir -p test-package
          pip install -r requirements.txt -t test-package/ --quiet
          cp app.py test-package/
          
          # Create zip
          cd test-package
          zip -r ../test-lambda-package.zip . -q
          cd ..
          
          # Check package size
          SIZE=$(stat -f%z test-lambda-package.zip 2>/dev/null || stat -c%s test-lambda-package.zip)
          SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
          
          echo "ğŸ“Š Package size: ${SIZE_MB}MB"
          
          if (( $(echo "$SIZE_MB > 50" | bc -l) )); then
            echo "âš ï¸ Warning: Package size exceeds 50MB limit for direct Lambda upload"
          else
            echo "âœ… Package size is within limits"
          fi
          
          # Cleanup
          rm -rf test-package test-lambda-package.zip

  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ“¥ Install Security Tools
        run: |
          pip install bandit safety
          cd backend
          pip install -r requirements.txt
          
      - name: ğŸ”’ Run Bandit Security Scan
        run: |
          cd backend
          echo "ğŸ”’ Running security scan with Bandit..."
          bandit -r app.py -f json -o bandit-report.json || true
          
          if [ -f bandit-report.json ]; then
            HIGH_ISSUES=$(jq '.metrics."_totals"."SEVERITY.HIGH"' bandit-report.json 2>/dev/null || echo 0)
            MEDIUM_ISSUES=$(jq '.metrics."_totals"."SEVERITY.MEDIUM"' bandit-report.json 2>/dev/null || echo 0)
            
            echo "ğŸ“Š Security scan results:"
            echo "  High severity issues: $HIGH_ISSUES"
            echo "  Medium severity issues: $MEDIUM_ISSUES"
            
            if [ "$HIGH_ISSUES" -gt "0" ]; then
              echo "âš ï¸ High severity security issues found"
              jq '.results[]' bandit-report.json 2>/dev/null || true
            else
              echo "âœ… No high severity security issues found"
            fi
          fi
          
      - name: ğŸ”’ Check Dependencies for Known Vulnerabilities
        run: |
          cd backend
          echo "ğŸ”’ Checking dependencies for known vulnerabilities..."
          safety check -r requirements.txt || true

  validate-config:
    name: âš™ï¸ Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4
        
      - name: âš™ï¸ Validate Lambda Handler
        run: |
          cd backend
          echo "âš™ï¸ Validating Lambda handler configuration..."
          
          # Check if lambda_handler function exists
          if grep -q "def lambda_handler" app.py; then
            echo "âœ… lambda_handler function found"
          else
            echo "âŒ lambda_handler function not found"
            exit 1
          fi
          
          # Check for required imports
          REQUIRED_IMPORTS=("json" "logging" "datetime" "boto3" "flask")
          for import in "${REQUIRED_IMPORTS[@]}"; do
            if grep -q "import $import" app.py; then
              echo "âœ… $import imported"
            else
              echo "âš ï¸ $import not found in imports"
            fi
          done
          
      - name: ğŸ“‹ Validate Requirements
        run: |
          cd backend
          echo "ğŸ“‹ Validating requirements.txt..."
          
          if [ ! -f requirements.txt ]; then
            echo "âŒ requirements.txt not found"
            exit 1
          fi
          
          # Check for required packages
          REQUIRED_PACKAGES=("Flask" "boto3" "PyJWT" "PyMySQL" "serverless-wsgi")
          for package in "${REQUIRED_PACKAGES[@]}"; do
            if grep -qi "$package" requirements.txt; then
              echo "âœ… $package found in requirements"
            else
              echo "âš ï¸ $package not found in requirements.txt"
            fi
          done

  api-structure-check:
    name: ğŸ”— API Structure Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ” Check API Endpoints
        run: |
          cd backend
          echo "ğŸ”— Checking API endpoint coverage..."
          
          # Required endpoints for frontend features
          REQUIRED_ENDPOINTS=(
            "/api/health"
            "/api/auth/login"
            "/api/auth/logout"
            "/api/dashboard/stats"
            "/api/subscribers"
            "/api/operations/bulk-delete"
            "/api/audit/compare"
            "/api/migration/jobs"
            "/api/migration/upload"
            "/api/analytics"
            "/api/config/provisioning-mode"
            "/api/provision/dashboard"
            "/api/export"
            "/api/audit/logs"
          )
          
          MISSING_ENDPOINTS=()
          
          for endpoint in "${REQUIRED_ENDPOINTS[@]}"; do
            if grep -q "$endpoint" app.py; then
              echo "âœ… $endpoint"
            else
              echo "âŒ $endpoint - MISSING"
              MISSING_ENDPOINTS+=("$endpoint")
            fi
          done
          
          if [ ${#MISSING_ENDPOINTS[@]} -eq 0 ]; then
            echo "ğŸ‰ All required API endpoints are implemented!"
          else
            echo "âš ï¸ Missing ${#MISSING_ENDPOINTS[@]} endpoints:"
            printf '%s\n' "${MISSING_ENDPOINTS[@]}"
          fi
          
      - name: ğŸ” Check Authentication Implementation
        run: |
          cd backend
          echo "ğŸ” Checking authentication implementation..."
          
          if grep -q "require_auth" app.py; then
            echo "âœ… Authentication decorator found"
          else
            echo "âŒ Authentication decorator missing"
          fi
          
          if grep -q "JWT" app.py; then
            echo "âœ… JWT implementation found"
          else
            echo "âŒ JWT implementation missing"
          fi

  comment-pr:
    name: ğŸ’¬ Comment on PR
    runs-on: ubuntu-latest
    needs: [lint-and-test, security-check, validate-config, api-structure-check]
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ’¬ Add PR Comment
        uses: actions/github-script@v6
        with:
          script: |
            const checkResults = {
              lintTest: '${{ needs.lint-and-test.result }}',
              security: '${{ needs.security-check.result }}',
              config: '${{ needs.validate-config.result }}',
              apiStructure: '${{ needs.api-structure-check.result }}'
            };
            
            const allPassed = Object.values(checkResults).every(result => result === 'success');
            const status = allPassed ? 'ğŸŸ¢ READY' : 'ğŸŸ¡ NEEDS ATTENTION';
            
            const body = `## âš™ï¸ Backend CI Results
            
            **Status:** ${status}
            
            ### ğŸ“‹ Check Results
            - **Lint & Test:** ${checkResults.lintTest === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
            - **Security Scan:** ${checkResults.security === 'success' ? 'âœ… Passed' : 'âŒ Failed'} 
            - **Config Validation:** ${checkResults.config === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
            - **API Structure:** ${checkResults.apiStructure === 'success' ? 'âœ… Passed' : 'âŒ Failed'}
            
            ### ğŸ“¦ Package Information
            - **Python Version:** 3.11
            - **Dependencies:** Validated
            - **Lambda Handler:** Validated
            
            ${allPassed ? 
              '### ğŸ‰ Ready for Deployment\n\nAll checks passed! This PR is ready to be merged and deployed.' :
              '### âš ï¸ Action Required\n\nSome checks failed. Please review the details above and fix any issues.'}
            
            ---
            
            **Next Steps:** ${allPassed ? 'Merge this PR to trigger automatic deployment to development environment.' : 'Fix failing checks and push updates.'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });